<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Noise to Color | goYippi labs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style type="text/css">
        @font-face {
          font-family: 'Source Sans Pro';
          font-style: normal;
          font-weight: 400;
          src: url('https://www.goyippi.net/wp-content/themes/goyippi/fonts/source-sans-pro/source-sans-pro-v11-latin-ext_latin-regular.eot'); /* IE9 Compat Modes */
          src: local('Source Sans Pro Regular'), local('SourceSansPro-Regular'),
               url('https://www.goyippi.net/wp-content/themes/goyippi/fonts/source-sans-pro/source-sans-pro-v11-latin-ext_latin-regular.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
               url('https://www.goyippi.net/wp-content/themes/goyippi/fonts/source-sans-pro/source-sans-pro-v11-latin-ext_latin-regular.woff2') format('woff2'), /* Super Modern Browsers */
               url('https://www.goyippi.net/wp-content/themes/goyippi/fonts/source-sans-pro/source-sans-pro-v11-latin-ext_latin-regular.woff') format('woff'), /* Modern Browsers */
               url('https://www.goyippi.net/wp-content/themes/goyippi/fonts/source-sans-pro/source-sans-pro-v11-latin-ext_latin-regular.ttf') format('truetype'), /* Safari, Android, iOS */
               url('https://www.goyippi.net/wp-content/themes/goyippi/fonts/source-sans-pro/source-sans-pro-v11-latin-ext_latin-regular.svg#SourceSansPro') format('svg'); /* Legacy iOS */
        }
        body {
            font-family: 'Source Sans Pro', Arial, sans-serif;
            font-size: 1.063em;
            line-height: 1.5;
            color: #000;
            background-color: #000;
            margin: 0;
            padding: 0 20px;
		        transition: background-color 0.25s;
        }
        .input-box {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
        }
        .input-box-inner {
            padding: 20px;
        }
        .error-box strong {
          font-weight: normal;
          color: #fe0000;
        }
    </style>
  </head>
  <body>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script type="text/javascript">
      var colorOutput = function(color) {
        var c = (color * 16777215) / 100;
        var r = Math.floor(c / (256*256));
        var g = Math.floor(c / 256) % 256;
        var b = Math.floor(c % 256);
        $('body').empty().css('background-color', 'rgb(' + r + ',' + g + ',' + b + ')');
      }

      var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

      // Morphasis answer: https://stackoverflow.com/questions/33322681/checking-microphone-volume-in-javascript
      navigator.mediaDevices.getUserMedia({ audio: true, video: false })
      .then(function(stream) {
        if ( isSafari ) {
          audioContext = new webkitAudioContext();
        } else {
          audioContext = new AudioContext();
        }

        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

        analyser.smoothingTimeConstant = 0.8;
        analyser.fftSize = 1024;

        microphone.connect(analyser);
        analyser.connect(javascriptNode);
        javascriptNode.connect(audioContext.destination);
        javascriptNode.onaudioprocess = function() {
          var array = new Uint8Array(analyser.frequencyBinCount);
          analyser.getByteFrequencyData(array);
          var values = 0;

          var length = array.length;
          for (var i = 0; i < length; i++) {
            values += (array[i]);
          }

          var average = values / length;

          console.log(Math.round(average));
          colorOutput( average );
        }
      })
      .catch(function(err) {
        $('body').append('<div class="input-box error-box"><div class="input-box-inner">The following error occured: <strong>' + err.name + '</strong><br />' + err.message + '<p></p></div></div>');
      });
    </script>
  </body>
</html>
